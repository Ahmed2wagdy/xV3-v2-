<!-- Property Detail Component HTML -->
<div class="container py-4" *ngIf="!isLoading && property">
  <!-- Back Button -->
  <div class="mb-3">
    <button class="btn btn-outline-primary" (click)="goBack()">
      <i class="bi bi-arrow-left"></i> Back to Properties
    </button>
  </div>

  <!-- Property Header -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h1 class="property-title">{{ property.title }}</h1>
          <p class="text-muted mb-2">
            <i class="bi bi-geo-alt"></i> {{ property.street }}, {{ property.city }}, {{ property.governate }}
          </p>
          <div class="property-meta">
            <span class="badge bg-primary me-2">{{ property.propertyType }}</span>
            <span class="text-muted">Listed {{ formatDate(property.listedAt) }}</span>
          </div>
        </div>
        <div class="text-end">
          <h2 class="price-tag">{{ formatPrice(property.price) }}</h2>
          <button class="btn btn-outline-danger" (click)="toggleFavorite()">
            <i class="bi" [ngClass]="{'bi-heart': !property.isFavorite, 'bi-heart-fill': property.isFavorite}"></i>
            {{ property.isFavorite ? 'Remove from Favorites' : 'Add to Favorites' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Gallery -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="image-gallery">
        <div class="main-image-container" *ngIf="property.propertyImages.length > 0">
          <img 
            [src]="property.propertyImages[currentImageIndex]" 
            [alt]="property.title"
            class="main-image"
            
          >
          
          <!-- Navigation arrows -->
          <button class="image-nav prev" (click)="previousImage()" *ngIf="property.propertyImages.length > 1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <button class="image-nav next" (click)="nextImage()" *ngIf="property.propertyImages.length > 1">
            <i class="bi bi-chevron-right"></i>
          </button>
          
          <!-- Image counter -->
          <div class="image-counter" *ngIf="property.propertyImages.length > 1">
            {{ currentImageIndex + 1 }} / {{ property.propertyImages.length }}
          </div>
        </div>
        
        <!-- Thumbnail gallery -->
        <div class="thumbnail-gallery" *ngIf="property.propertyImages.length > 1">
          <div class="row g-2">
            <div class="col-2" *ngFor="let image of property.propertyImages; let i = index">
              <img 
                #thumbImg
                [src]="image" 
                [alt]="property.title + ' - Image ' + (i + 1)"
                class="thumbnail"
                [class.active]="i === currentImageIndex"
                (click)="selectImage(i)"
                (error)="thumbImg.src='assets/images/apartment.avif'"
              >
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Property Info Sidebar -->
    <div class="col-lg-4">
      <div class="property-info-card">
        <h4>Property Details</h4>
        <div class="property-details">
          <div class="detail-row">
            <span class="detail-label">Size:</span>
            <span class="detail-value">{{ property.size }} m²</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Bedrooms:</span>
            <span class="detail-value">{{ property.bedrooms }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Bathrooms:</span>
            <span class="detail-value">{{ property.bathrooms }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Type:</span>
            <span class="detail-value">{{ property.propertyType }}</span>
          </div>
        </div>

        <!-- Owner Info -->
        <div class="owner-info mt-4">
          <h5>Owner Information</h5>
          <p class="mb-1">
            <strong>{{ property.ownerInfo.firstName }} {{ property.ownerInfo.lastName }}</strong>
          </p>
          <p class="mb-1">
            <i class="bi bi-envelope"></i> {{ property.ownerInfo.email }}
          </p>
          <p class="mb-3">
            <i class="bi bi-phone"></i> {{ property.ownerInfo.phoneNumber }}
          </p>
          <button class="btn btn-success w-100" (click)="contactOwner()">
            <i class="bi bi-whatsapp"></i> Contact via WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Property Description -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="description-section">
        <h3>Description</h3>
        <p>{{ property.description }}</p>
      </div>
    </div>
  </div>

  <!-- Amenities -->
  <div class="row mb-4" *ngIf="property.internalAmenities.length > 0 || property.externalAmenities.length > 0 || property.accessibilityAmenities.length > 0">
    <div class="col-12">
      <div class="amenities-section">
        <h3>Amenities</h3>
        <div class="row">
          <div class="col-md-4" *ngIf="property.internalAmenities.length > 0">
            <h5>Internal Amenities</h5>
            <ul class="amenities-list">
              <li *ngFor="let amenity of property.internalAmenities">
                <i class="bi bi-check-circle text-success"></i> {{ amenity }}
              </li>
            </ul>
          </div>
          <div class="col-md-4" *ngIf="property.externalAmenities.length > 0">
            <h5>External Amenities</h5>
            <ul class="amenities-list">
              <li *ngFor="let amenity of property.externalAmenities">
                <i class="bi bi-check-circle text-success"></i> {{ amenity }}
              </li>
            </ul>
          </div>
          <div class="col-md-4" *ngIf="property.accessibilityAmenities.length > 0">
            <h5>Accessibility Features</h5>
            <ul class="amenities-list">
              <li *ngFor="let amenity of property.accessibilityAmenities">
                <i class="bi bi-check-circle text-success"></i> {{ amenity }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="row">
    <div class="col-12">
      <div class="reviews-section">
        <h3>Reviews</h3>
        
        <!-- Add Review Form -->
        <div class="add-review-card mb-4" *ngIf="isLoggedIn">
          <h5>Leave a Review</h5>
          <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
            <div class="mb-3">
              <label class="form-label">Rating</label>
              <div class="star-rating">
                <div class="star-input">
                  <input type="radio" formControlName="rating" value="1" id="star1">
                  <label for="star1">⭐</label>
                  <input type="radio" formControlName="rating" value="2" id="star2">
                  <label for="star2">⭐</label>
                  <input type="radio" formControlName="rating" value="3" id="star3">
                  <label for="star3">⭐</label>
                  <input type="radio" formControlName="rating" value="4" id="star4">
                  <label for="star4">⭐</label>
                  <input type="radio" formControlName="rating" value="5" id="star5">
                  <label for="star5">⭐</label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comment</label>
              <textarea 
                class="form-control" 
                formControlName="comment" 
                rows="3" 
                placeholder="Share your experience with this property..."
                [disabled]="isSubmittingReview"
              ></textarea>
              <div *ngIf="reviewForm.get('comment')?.invalid && reviewForm.get('comment')?.touched" class="text-danger small">
                Comment must be at least 10 characters long
              </div>
            </div>
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="reviewForm.invalid || isSubmittingReview"
            >
              <span *ngIf="!isSubmittingReview">Submit Review</span>
              <span *ngIf="isSubmittingReview">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Submitting...
              </span>
            </button>
          </form>
        </div>

        <!-- Login prompt for guests -->
        <div class="alert alert-info" *ngIf="!isLoggedIn">
          <i class="bi bi-info-circle"></i>
          Please <a [routerLink]="['/log-in']" class="alert-link">log in</a> to leave a review.
        </div>

        <!-- Reviews List -->
        <div class="reviews-list">
          <div class="review-card" *ngFor="let review of reviews">
            <div class="review-header">
              <div class="reviewer-info">
                <strong>{{ review.userName || 'Anonymous' }}</strong>
                <div class="rating">
                  <span *ngFor="let star of getStarArray(review.rating)" class="star filled">⭐</span>
                  <span *ngFor="let star of getStarArray(5 - review.rating)" class="star">☆</span>
                </div>
              </div>
              <small class="text-muted">{{ formatDate(review.reviewDate || '') }}</small>
            </div>
            <p class="review-comment">{{ review.comment }}</p>
          </div>
          
          <div *ngIf="reviews.length === 0" class="no-reviews">
            <p class="text-muted text-center">No reviews yet. Be the first to review this property!</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p>Loading property details...</p>
</div>